# デプロイ状況

## 📅 最終更新日時
2026年2月6日

## 🌐 デプロイ先
https://uchu-roku.github.io/nitay_design_verup/

## ✅ 最新のデプロイ

### コミット情報
- **コミットID**: d015008 (凡例のLegendPanel完全集約)
- **ブランチ**: main
- **日時**: 2026年2月6日

### 最新の変更内容
**凡例システムの完全リファクタリング**
- 旧凡例（地図上カード3種類）を完全削除
- 凡例をLegendPanel 1箇所に完全集約
- treePointsの有無で凡例の表示/非表示を動的制御
- 新規作成: LegendPanel.jsx, LegendPanel.css, legendRegistry.js
- SHOW_LEGENDSフラグを完全削除（復活スイッチを根絶）

## 🔧 修正内容

### 1. KEYCODEの構造を正しく理解

**KEYCODE構造（14桁）**:
```
01 05 0000 0100 01
│  │  │    │    └─ 13-14桁目: 枝番
│  │  │    └────── 9-12桁目: 小班
│  │  └─────────── 5-8桁目: 林班
│  └────────────── 3-4桁目: 市町村コード
└───────────────── 1-2桁目: 振興局コード
```

**例**: `01050000010001`
- 振興局: `01` (渡島)
- 市町村: `05` (北斗市)

### 2. レイヤーファイル名の変更

**変更前**: `layers_01050.json` (5桁 - 誤り)
**変更後**: `layers_0105.json` (4桁 - 正解)

### 3. 解決した問題

#### 問題1: 北斗市・函館市が表示されない
- **原因**: KEYCODEの解釈が間違っていた（3-5桁目を市町村コードとしていた）
- **解決**: 1-4桁目を市町村コードとして正しく抽出

#### 問題2: 属性テーブルの数値が「—」表示
- **原因**: レイヤーデータが読み込めていなかった（ファイル名の不一致）
- **解決**: 正しいファイル名でデータを読み込み、面積・樹種・林齢などが表示されるようになった

#### 問題3: 市町村リストが不完全
- **原因**: 2桁コードと4桁コードのマッピングが不正確
- **解決**: 正しいマッピングファイルを作成

## 📊 対応市町村一覧（全11市町村）

| 2桁コード | 4桁コード | 市町村名 | レイヤーファイル | データ件数 |
|----------|----------|---------|----------------|-----------|
| 01 | 0101 | 松前町 | layers_0101.json | 4,776件 |
| 02 | 0102 | 福島町 | layers_0102.json | 5,315件 |
| 03 | 0103 | 知内町 | layers_0103.json | 5,086件 |
| 04 | 0104 | 木古内町 | layers_0104.json | 7,613件 |
| 05 | 0105 | **北斗市** | **layers_0105.json** | **7,313件** |
| 07 | 0107 | 七飯町 | layers_0107.json | 4,475件 |
| 13 | 0113 | 鹿部町 | layers_0113.json | 2,923件 |
| 15 | 0115 | 森町 | layers_0115.json | 10,290件 |
| 16 | 0116 | 八雲町 | layers_0116.json | 18,154件 |
| 17 | 0117 | 長万部町 | layers_0117.json | 4,194件 |
| 19 | 0119 | **函館市** | **layers_0119.json** | **16,846件** |

**合計**: 86,985件

## 🔍 確認方法

### 1. GitHub Actions の確認

https://github.com/uchu-roku/nitay_design_verup/actions

最新のワークフロー（コミット 98feb6e）が成功しているか確認してください。

### 2. デプロイされたサイトの確認

https://uchu-roku.github.io/nitay_design_verup/

#### 確認項目

- [x] サイトが表示される
- [x] 市町村リストに全11市町村が表示される
- [x] 「北斗市」と「函館市」が選択できる
- [x] 「森林簿レイヤ ON」ボタンをクリック
- [x] 小班データが地図上に表示される
- [x] 小班をクリックして層データが表示される
- [x] 属性テーブルに面積・樹種・林齢などの数値が正しく表示される
- [x] **凡例がサイドバーのLegendPanelのみに表示される**
- [x] **地図上に凡例カードが表示されない**

### 3. 属性テーブルの確認

小班をクリックした際、以下のデータが正しく表示されることを確認：

- **面積**: 数値（例: 1.10 ha）
- **樹種**: 名前（例: 天然林広葉樹）
- **林齢**: 数値（例: 34年）
- **林種**: 名前（例: 天然林）
- **森林種類**: 名前（例: 普通林）

## 📝 技術的な詳細

### データ構造の例

#### レイヤーデータ（layers_0105.json）
```json
{
  "01050000010001": [
    {
      "KEYCODE": "01050000010001",
      "面積": "1.1",
      "樹種1名": "天然林広葉樹",
      "林齢": "34",
      "林種名": "天       然       林",
      "森林の種類1名": "普通林",
      "HA当蓄積L": "71",
      "成長率L": "0.026"
    }
  ]
}
```

### コード修正箇所

#### Map.jsx
```javascript
// 修正前
const munCode = keycode.substring(2, 5) // 3-5桁目（誤り）

// 修正後
const munCode = keycode.substring(0, 4) // 1-4桁目（正解）
```

#### split_layers_by_municipality.py
```python
# 修正前
muni_code = keycode[:5]  # 最初の5桁（誤り）

# 修正後
muni_code = keycode[:4]  # 最初の4桁（正解）
```

## 🚀 デプロイ履歴

1. **d015008** (2026/02/06) - 凡例のLegendPanel完全集約
   - 旧凡例（地図上カード3種類）を完全削除
   - 凡例をサイドバーのLegendPanelに統一
   - 新規作成: LegendPanel.jsx, LegendPanel.css, legendRegistry.js
   - 7ファイル変更: +231行, -197行
2. **98feb6e** (2026/02/04 23:15) - ドキュメント追加
3. **fd043df** (2026/02/04 23:10) - KEYCODE構造修正、レイヤーファイル名変更
4. **b5059c7** (2026/02/04 22:50) - 市町村コードマッピング追加
5. **98b4db2** (2026/02/04) - デプロイトリガー

## 📞 トラブルシューティング

### 属性テーブルに「—」が表示される場合

1. ブラウザのコンソールを開く（F12）
2. ネットワークタブで `layers_*.json` の読み込みを確認
3. ファイルが404エラーの場合、ファイル名を確認
4. ファイルが正しく読み込まれているのにデータが表示されない場合、フィールド名を確認

### 市町村が表示されない場合

1. `municipality_codes.json` が正しく読み込まれているか確認
2. `municipality_mapping.json` が存在するか確認
3. ブラウザのキャッシュをクリア

### GitHub Actions が失敗する場合

1. Actions タブでログを確認
2. ビルドエラーがないか確認
3. 必要に応じてコードを修正

## 📚 関連ドキュメント

- [KEYCODE修正サマリー](KEYCODE_FIX_SUMMARY.md)
- [市町村表示問題修正サマリー](MUNICIPALITY_FIX_SUMMARY.md)
- [データ管理ガイド](.kiro/steering/data-management.md)
