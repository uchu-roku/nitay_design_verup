# KEYCODE構造修正サマリー

## 修正内容

### 1. KEYCODEの正しい構造

**誤り**: 1-2桁目が振興局、3-5桁目が市町村コード（5桁）
**正解**: 1-2桁目が振興局、3-4桁目が市町村コード（4桁）

#### KEYCODE構造（14桁）
```
01 05 0000 0100 01
│  │  │    │    └─ 13-14桁目: 枝番
│  │  │    └────── 9-12桁目: 小班
│  │  └─────────── 5-8桁目: 林班
│  └────────────── 3-4桁目: 市町村コード
└───────────────── 1-2桁目: 振興局コード
```

**例**: `01050000010001`
- 振興局: `01` (渡島)
- 市町村: `05` (北斗市)
- 林班: `0000`
- 小班: `0100`
- 枝番: `01`

### 2. レイヤーファイル名の変更

**変更前**: `layers_01050.json` (5桁)
**変更後**: `layers_0105.json` (4桁)

#### 全11市町村のファイル名

| 市町村名 | 旧ファイル名 | 新ファイル名 |
|---------|------------|------------|
| 松前町 | layers_01010.json | layers_0101.json |
| 福島町 | layers_01020.json | layers_0102.json |
| 知内町 | layers_01030.json | layers_0103.json |
| 木古内町 | layers_01040.json | layers_0104.json |
| **北斗市** | layers_01050.json | **layers_0105.json** |
| 七飯町 | layers_01070.json | layers_0107.json |
| 鹿部町 | layers_01130.json | layers_0113.json |
| 森町 | layers_01150.json | layers_0115.json |
| 八雲町 | layers_01160.json | layers_0116.json |
| 長万部町 | layers_01170.json | layers_0117.json |
| **函館市** | layers_01190.json | **layers_0119.json** |

### 3. コード修正

#### Map.jsx
```javascript
// 修正前
const munCode = keycode.substring(2, 5) // 3-5桁目（誤り）

// 修正後
const munCode = keycode.substring(0, 4) // 1-4桁目（正解）
```

#### split_layers_by_municipality.py
```python
# 修正前
muni_code = keycode[:5]  # 最初の5桁（誤り）

# 修正後
muni_code = keycode[:4]  # 最初の4桁（正解）
```

### 4. municipality_mapping.json の修正

```json
{
  "05": {
    "code4": "0105",  // 5桁から4桁に変更
    "name": "北斗市"
  },
  "19": {
    "code4": "0119",  // 5桁から4桁に変更
    "name": "函館市"
  }
}
```

## 解決した問題

### 問題1: 市町村が表示されない
- **原因**: KEYCODEの解釈が間違っていたため、正しいファイルを読み込めなかった
- **解決**: 1-4桁目を市町村コードとして正しく抽出

### 問題2: 属性テーブルの数値が「—」表示
- **原因**: レイヤーデータが読み込めていなかった（ファイル名の不一致）
- **解決**: 正しいファイル名でデータを読み込み、面積・樹種・林齢などが正しく表示されるようになった

## デプロイ情報

- **コミットID**: fd043df
- **プッシュ日時**: 2026年2月4日 23:10
- **デプロイ先**: https://uchu-roku.github.io/nitay_designtest/

## 確認事項

GitHub Actions のビルドが完了後、以下を確認してください：

1. ✅ 市町村リストに全11市町村が表示される
2. ✅ 北斗市と函館市が選択できる
3. ✅ 小班をクリックすると層データが表示される
4. ✅ 属性テーブルに面積・樹種・林齢などの数値が正しく表示される

## データ検証

実際のレイヤーデータ（layers_0105.json の例）:
```json
{
  "KEYCODE": "01050000010001",
  "面積": "1.1",
  "樹種1名": "天然林広葉樹",
  "林齢": "34",
  "林種名": "天       然       林",
  "森林の種類1名": "普通林"
}
```

すべてのフィールドが正しく存在し、数値データも含まれています。
